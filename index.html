<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Bilancio Personale Completo</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 1000px;
    margin: 20px auto;
    background: #f7f7f7;
  }
  h1 {
    text-align: center;
    margin-bottom: 5px;
  }
  #saldoTotaleBar {
    position: sticky;
    top: 0;
    background: #339cff;
    color: white;
    font-weight: bold;
    padding: 15px;
    font-size: 1.3em;
    text-align:center;
    border-radius: 0 0 8px 8px;
    margin-bottom: 18px;
    z-index: 1000;
  }
  nav {
    margin: 20px 0;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }
  nav button {
    padding: 10px 25px;
    font-size: 1.1em;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: filter 0.3s ease;
  }
  nav button.active,
  nav button:hover {
    filter: brightness(0.85);
  }
  #btnInput { background-color: #c92a2a; color: white; }
  #btnDettaglio { background-color: #d9a620; color: #222; }
  #btnBudget, #btnCategorie { background-color: #6c757d; color: white; }
  #btnSaldo { background-color: #339cff; color: white; }
  section {
    display: none;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 1px 2px 8px #bbb;
    min-height: 320px;
    transition: opacity 0.3s ease;
  }
  section.active {
    display: block;
    opacity: 1;
  }
  label {
    font-weight: bold;
    margin-top: 12px;
    display: block;
  }
  select, input, button, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
    font-family: inherit;
    resize: vertical;
  }
  button[type='submit'], button.del-btn, button.budgetDel {
    margin-top: 20px;
    border: none;
    border-radius: 7px;
    cursor: pointer;
    font-weight: bold;
    padding: 10px;
    user-select: none;
  }
  button[type='submit'], #saveBudgetBtn {
    background-color: #6c757d;
    color: white;
  }
  button[type='submit']:hover, button.del-btn:hover, button.budgetDel:hover, #saveBudgetBtn:hover {
    filter: brightness(0.85);
  }
  button.del-btn, button.budgetDel {
    background-color: #c92a2a;
    color: white;
    padding: 6px 14px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    user-select: none;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
    vertical-align: middle;
    user-select: text;
  }
  th {
    background-color: #eee;
    font-weight: bold;
    user-select: text;
  }
  option.essenziale {
    background-color: #ffe5e5 !important;
    color: #b20000 !important;
    font-weight: bold;
  }
  option.extra {
    background-color: #fff9e3 !important;
    color: #b38800 !important;
    font-weight: bold;
  }
  option.entrata {
    background-color: #eaffea !important;
    color: #067e15 !important;
    font-weight: bold;
  }
  tr.essenziale td {
    background-color: #fff2f2;
    color: #a10000;
  }
  tr.extra td {
    background-color: #fffbe6;
    color: #a67c00;
  }
  tr.entrata td {
    background-color: #e7f9e7;
    color: #056605;
  }
  .saldo-box {
    padding: 15px;
    border-radius: 7px;
    min-width: 140px;
    font-weight: bold;
    color: #333;
  }
  .essenzialeSaldo { background: #ffe5e5; color: #b20000; }
  .extraSaldo { background: #fff9e3; color: #a97400; }
  .entrataSaldo { background: #e7f9e7; color: #056605; }
  #budgetNavigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  #budgetMonthDisplay {
    font-weight: bold;
    font-size: 1.1em;
  }
  #budgetTableContainer {
    max-height: 400px;
    overflow-y: auto;
  }
  #budgetTable tbody input[type="number"] {
    width: 80px;
    padding: 6px;
  }
</style>
</head>
<body>

<h1>Bilancio Personale</h1>
<div id="saldoTotaleBar" aria-live="polite" role="region" aria-label="Saldo totale">Saldo totale: €0.00</div>

<nav aria-label="Navigazione">
  <button id="btnInput" class="active" title="Inserimento nuovo movimento">Input</button>
  <button id="btnDettaglio" title="Dettaglio movimenti">Dettaglio</button>
  <button id="btnBudget" title="Gestione budget">Budget</button>
  <button id="btnCategorie" title="Gestione categorie">Categorie</button>
  <button id="btnSaldo" title="Visualizza saldo">Saldo</button>
</nav>

<section id="tabInput" class="active" aria-label="Inserimento nuovo movimento">
  <h2>Nuovo Movimento</h2>
  <form id="movForm">
    <label for="tipo">Tipo<span style="color:#b20000;">*</span></label>
    <select id="tipo" required aria-required="true">
      <option value="Uscita" selected>Uscita</option>
      <option value="Entrata">Entrata</option>
    </select>

    <label for="fonte">Fonte<span style="color:#b20000;">*</span></label>
    <select id="fonte" required aria-required="true">
      <option value="CONTANTI" class="essenziale" selected>CONTANTI</option>
      <option value="REVOLUT" class="essenziale">REVOLUT</option>
      <option value="UNICREDIT" class="essenziale">UNICREDIT</option>
      <option value="ISYBANK" class="essenziale">ISYBANK</option>
      <option value="BANCO SANTANDER" class="essenziale">BANCO SANTANDER</option>
    </select>

    <label for="data">Data<span style="color:#b20000;">*</span></label>
    <input type="date" id="data" required aria-required="true" />

    <label for="euro">Importo (€)<span style="color:#b20000;">*</span></label>
    <input type="number" id="euro" min="0" step="0.01" required aria-required="true" />

    <label for="descrizione">Descrizione (opzionale)</label>
    <input type="text" id="descrizione" placeholder="Descrizione (opzionale)" aria-required="false" />

    <label for="categoria">Categoria<span style="color:#b20000;">*</span></label>
    <select id="categoria" required aria-required="true"></select>

    <button type="submit">Aggiungi</button>
  </form>
</section>

<section id="tabDettaglio" aria-label="Dettaglio movimenti">
  <h2>Dettaglio Movimenti</h2>
  <table id="dettaglioTable" role="grid" aria-describedby="dettaglioDescr">
    <thead>
      <tr>
        <th>Tipo</th><th>Fonte</th><th>Data</th><th>Mese</th><th>Anno</th><th>Euro</th><th>Descrizione</th><th>Categoria</th><th>Azioni</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p id="dettaglioDescr" hidden>Movimenti raggruppati per mese. Puoi eliminarli singolarmente.</p>
</section>

<section id="tabBudget" aria-label="Budget mensile">
  <h2>Budget Mensile</h2>
  <div id="budgetNavigation">
    <button id="prevMonthBtn" title="Mese precedente">&lt;</button>
    <span id="budgetMonthDisplay" aria-live="polite" aria-atomic="true" style="font-weight: bold; font-size: 1.2em; line-height: 38px;"></span>
    <button id="nextMonthBtn" title="Mese successivo">&gt;</button>
  </div>
  <div id="budgetTableContainer" style="max-height: 400px; overflow-y: auto;">
    <table id="budgetTable" role="grid">
      <thead>
        <tr><th>Categoria</th><th>Budget (€)</th><th>Spese (€)</th><th>Rimanente (€)</th><th>% Usato</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <form id="budgetEditForm" style="margin-top: 15px;">
    <h3>Modifica Budget per Categoria</h3>
    <table style="width: 100%; border-collapse: collapse;">
      <tbody id="budgetEditBody"></tbody>
    </table>
    <button type="submit" style="margin-top: 10px;">Salva Budget</button>
  </form>
</section>

<section id="tabCategorie" aria-label="Gestione categorie">
  <h2>Gestione Categorie</h2>
  <form id="newCatForm">
    <label for="nuovaCat">Nuova categoria<span style="color:#b20000;">*</span></label>
    <input type="text" id="nuovaCat" autocomplete="off" aria-required="true" />
    <label for="catTipo">Tipo<span style="color:#b20000;">*</span></label>
    <select id="catTipo" aria-required="true">
      <option value="Uscita">Uscita</option>
      <option value="Entrata">Entrata</option>
    </select>
    <button type="submit">Aggiungi</button>
  </form>
  <table id="catTable" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
    <thead><tr><th>Tipo</th><th>Categoria</th><th>Azioni</th></tr></thead>
    <tbody id="catTabBody"></tbody>
  </table>
</section>

<section id="tabSaldo" aria-label="Saldo">
  <h2>Saldo Conti</h2>
  <div style="display:flex; gap:20px; flex-wrap: wrap;">
    <div class="saldo-box essenzialeSaldo" id="saldoContanti">Contanti: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoRevolut">Revolut: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoUnicredit">Unicredit: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoIsybank">Isybank: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoSantander">Banco Santander: €0.00</div>
  </div>
</section>

<script>
  const startCategories = {
    Uscita: [
      "TRASPORTI", "AFFITTO", "UTENZE", "SPESA E ALIMENTARI","CURA PERSONALE",
      "SPESE MEDICHE", "VESTITI ESSENZIALI", "COSE DELLA CASA", "SPSE SCOLASTICHE",
      "RISTORANTE", "VACANZA", "REGALI", "ALTRO EXTRA", "USCITE", "SIGARETTE"
    ],
    Entrata: ["Lavoro", "Mamma", "Nonna", "Roxana", "Entrate extra", "Rimborsi"]
  };
  const contiArr = ["CONTANTI","REVOLUT","UNICREDIT","ISYBANK","BANCO SANTANDER"];

  function capitalize(str) {
    if (!str) return "";
    return str.charAt(0).toUpperCase() + str.slice(1);
  }
  function meseToNum(nomeMese) {
    const mesi = {gennaio:1,febbraio:2,marzo:3,aprile:4,maggio:5,giugno:6,luglio:7,agosto:8,settembre:9,ottobre:10,novembre:11,dicembre:12};
    return mesi[nomeMese.toLowerCase()] || 0;
  }
  function getCurrentMonthFormatted() {
    const d = new Date();
    return d.toLocaleDateString("it-IT",{year:"numeric",month:"long"});
  }

  // Category management
  function loadCategories() {
    let cats = JSON.parse(localStorage.getItem("categorie"));
    if (!cats) {
      localStorage.setItem("categorie", JSON.stringify(startCategories));
      return JSON.parse(JSON.stringify(startCategories));
    }
    return cats;
  }
  function saveCategories(cats) {
    localStorage.setItem("categorie", JSON.stringify(cats));
  }
  function setCategoryOptions(tipo) {
    const select = document.getElementById("categoria");
    select.innerHTML = '<option value="">Seleziona categoria</option>';
    loadCategories()[tipo].forEach(cat=>{
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      if(startCategories.Uscita.includes(cat)) opt.className = "essenziale";
      else if(startCategories.Entrata.includes(cat)) opt.className = "entrata";
      if(["RISTORANTE", "VACANZA", "REGALI", "ALTRO EXTRA", "USCITE", "SIGARETTE"].includes(cat)) opt.className = "extra";
      select.appendChild(opt);
    });
  }
  document.getElementById("tipo").addEventListener("change", e=>setCategoryOptions(e.target.value));

  document.getElementById("newCatForm").onsubmit = e => {
    e.preventDefault();
    let newCat = document.getElementById("nuovaCat").value.trim();
    let tipo = document.getElementById("catTipo").value;
    if(!newCat){
      alert("Inserisci una categoria");
      return;
    }
    let cats = loadCategories();
    if(cats[tipo].includes(newCat)){
      alert("Categoria già esistente");
      return;
    }
    cats[tipo].push(newCat);
    saveCategories(cats);
    renderCategorie();
    setCategoryOptions(document.getElementById("tipo").value);
    document.getElementById("nuovaCat").value = "";
    alert("Categoria aggiunta!");
  };
  function renderCategorie() {
    const tbody = document.getElementById("catTabBody");
    tbody.innerHTML = "";
    const cats = loadCategories();
    ["Uscita","Entrata"].forEach(tipo=>{
      cats[tipo].forEach((cat,i)=>{
        let tr = document.createElement("tr");
        let bg="", fg="";
        if(startCategories.Uscita.includes(cat)) { bg="#ffe5e5"; fg="#b20000"; }
        else if(startCategories.Entrata.includes(cat)) { bg="#d8fbe0"; fg="#056005"; }
        if(["RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"].includes(cat)) { bg="#fff9d4"; fg="#a97400"; }
        tr.style.backgroundColor = bg;
        tr.style.color = fg;
        tr.innerHTML = `<td>${tipo}</td><td>${cat}</td><td><button class="del-btn" data-tipo="${tipo}" data-index="${i}">Elimina</button></td>`;
        tbody.appendChild(tr);
        tr.querySelector(".del-btn").onclick = () => {
          const c = loadCategories();
          c[tipo].splice(i, 1);
          saveCategories(c);
          renderCategorie();
          setCategoryOptions(document.getElementById("tipo").value);
        };
      });
    });
  }

  // Movimenti management
  document.getElementById("movForm").onsubmit = e => {
    e.preventDefault();
    let tipo = document.getElementById("tipo").value;
    let fonte = document.getElementById("fonte").value;
    let data = document.getElementById("data").value;
    let euro = parseFloat(document.getElementById("euro").value);
    let descrizione = document.getElementById("descrizione").value || "";
    let categoria = document.getElementById("categoria").value;
    if(!categoria){
      alert("Seleziona una categoria");
      return;
    }
    let dt = new Date(data);
    let mese = dt.toLocaleDateString("it-IT", {month:"long"});
    let anno = dt.getFullYear();
    let movs = JSON.parse(localStorage.getItem("movimenti")||"[]");
    movs.push({tipo, fonte, data, euro, descrizione, categoria, mese, anno});
    localStorage.setItem("movimenti", JSON.stringify(movs));
    loadDettaglio();
    calcSaldo();
    resetForm();
    displayBudget(currentBudgetMonth || getCurrentMonthFormatted());
    alert("Movimento inserito!");
  };
  function resetForm(){
    document.getElementById("movForm").reset();
    document.getElementById("tipo").value = "Uscita";
    setCategoryOptions("Uscita");
    document.getElementById("fonte").value = "CONTANTI";
    document.getElementById("data").value = new Date().toISOString().split("T")[0];
  }
  function loadDettaglio(){
    const tbody = document.querySelector("#dettaglioTable tbody");
    tbody.innerHTML = "";
    const movs = JSON.parse(localStorage.getItem("movimenti") || "[]");
    if(movs.length === 0) return;
    let gruppi = {};
    movs.forEach(m => {
      let key = m.anno + "-" + m.mese.toLowerCase();
      if(!gruppi[key]) gruppi[key] = [];
      gruppi[key].push(m);
    });
    let keys = Object.keys(gruppi).sort((a,b) => {
      let [yA,mA] = a.split("-");
      let [yB,mB] = b.split("-");
      return new Date(yA, meseToNum(mA)-1) - new Date(yB, meseToNum(mB)-1);
    });
    keys.forEach(k => {
      let [anno,mese] = k.split("-").reverse();
      let trHeader = document.createElement("tr");
      trHeader.className = "month-header";
      trHeader.innerHTML = `<td colspan="9">${capitalize(mese)} ${anno}</td>`;
      tbody.appendChild(trHeader);
      gruppi[k].forEach(m => {
        let tr = document.createElement("tr");
        let cls = "";
        if(startCategories.Uscita.includes(m.categoria)) cls = "essenziale";
        else if(startCategories.Entrata.includes(m.categoria)) cls = "entrata";
        else if(["RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"].includes(m.categoria)) cls = "extra";
        tr.className = cls;
        tr.innerHTML = `
          <td>${m.tipo}</td><td>${m.fonte}</td><td>${m.data}</td><td>${m.mese}</td><td>${m.anno}</td>
          <td>€ ${m.euro.toFixed(2)}</td><td>${m.descrizione}</td><td>${m.categoria}</td>
          <td><button class="del-btn">Elimina</button></td>
        `;
        tbody.appendChild(tr);
        tr.querySelector('.del-btn').onclick = () => {
          const idx = movs.indexOf(m);
          if(idx > -1){
            movs.splice(idx, 1);
            localStorage.setItem("movimenti", JSON.stringify(movs));
            loadDettaglio();
            calcSaldo();
            displayBudget(currentBudgetMonth || getCurrentMonthFormatted());
          }
        };
      });
    });
  }

  // Saldo con Banco Santander incluso
  function calcSaldo(){
    const movs = JSON.parse(localStorage.getItem("movimenti") || "[]");
    const saldo = {CONTANTI:0, REVOLUT:0, UNICREDIT:0, ISYBANK:0, "BANCO SANTANDER":0};
    movs.forEach(m => {
      if(contiArr.includes(m.fonte)){
        (m.tipo === "Entrata" ? saldo[m.fonte]+=m.euro : saldo[m.fonte]-=m.euro);
      }
    });
    document.getElementById("saldoTotaleBar").textContent = "Saldo totale: €" + Object.values(saldo).reduce((a,b)=>a+b,0).toFixed(2);
    document.getElementById("saldoContanti").textContent = `Contanti: €${saldo.CONTANTI.toFixed(2)}`;
    document.getElementById("saldoRevolut").textContent = `Revolut: €${saldo.REVOLUT.toFixed(2)}`;
    document.getElementById("saldoUnicredit").textContent = `Unicredit: €${saldo.UNICREDIT.toFixed(2)}`;
    document.getElementById("saldoIsybank").textContent = `Isybank: €${saldo.ISYBANK.toFixed(2)}`;
    document.getElementById("saldoSantander").textContent = `Banco Santander: €${saldo["BANCO SANTANDER"].toFixed(2)}`;
  }

  // Budget mensile con navigazione mese e modifica categorie
  let currentBudgetMonth = null;
  const budgetTableBody = document.querySelector("#budgetTable tbody");
  const budgetEditBody = document.getElementById("budgetEditBody");
  const budgetMonthDisplay = document.getElementById("budgetMonthDisplay");

  function displayBudget(month) {
    if(!month) month = getCurrentMonthFormatted();
    currentBudgetMonth = month.toLowerCase();
    budgetMonthDisplay.textContent = `Budget per ${capitalize(month)}`;

    const budget = JSON.parse(localStorage.getItem("budget_" + currentBudgetMonth) || "{}");
    const movs = JSON.parse(localStorage.getItem("movimenti") || "[]");
    let [meseNome, annoStr] = currentBudgetMonth.split(" ");
    let anno = parseInt(annoStr);

    let expenses = {};
    movs.forEach(m => {
      if(m.tipo === "Uscita" && m.mese.toLowerCase() === meseNome && m.anno === anno){
        expenses[m.categoria] = (expenses[m.categoria] || 0)+ m.euro;
      }
    });

    const catsAll = [...loadCategories().Uscita, ...loadCategories().Entrata].sort();

    budgetTableBody.innerHTML = "";
    budgetEditBody.innerHTML = "";

    catsAll.forEach(cat => {
      let budgVal = parseFloat(budget[cat]) || 0;
      let spentVal = expenses[cat] || 0;
      let remainVal = budgVal - spentVal;
      let percent = budgVal > 0 ? (spentVal / budgVal) * 100 : 0;
      let trClass = startCategories.Uscita.includes(cat) ? "essenziale" : (startCategories.Entrata.includes(cat) ? "entrata" : "extra");

      // Visualizza Budget Riepilogativo
      let tr = document.createElement("tr");
      tr.className = trClass;
      tr.innerHTML = `<td>${cat}</td><td>€ ${budgVal.toFixed(2)}</td><td>€ ${spentVal.toFixed(2)}</td><td>€ ${remainVal.toFixed(2)}</td><td>${percent.toFixed(1)}%</td>`;
      budgetTableBody.appendChild(tr);

      // Form modifica budget
      let trEdit = document.createElement("tr");
      trEdit.className = trClass;
      trEdit.innerHTML = `<td style="text-align:left;">${cat}<input type="hidden" name="category" value="${cat}"/></td><td><input type="number" name="budget" min="0" step="0.01" value="${budgVal.toFixed(2)}"/></td>`;
      budgetEditBody.appendChild(trEdit);
    });
  }

  document.getElementById("budgetEditForm").onsubmit = e => {
    e.preventDefault();
    if(!currentBudgetMonth) currentBudgetMonth = getCurrentMonthFormatted().toLowerCase();
    const formData = new FormData(e.target);
    const categories = formData.getAll('category');
    const budgets = formData.getAll('budget');
    let newBudget = {};
    for(let i=0; i<categories.length; i++){
      const val = parseFloat(budgets[i]);
      if(!isNaN(val) && val >= 0) newBudget[categories[i]] = val;
    }
    if(confirm(`Sei sicuro di aggiornare il budget per ${capitalize(currentBudgetMonth)}?`)){
      localStorage.setItem("budget_" + currentBudgetMonth, JSON.stringify(newBudget));
      localStorage.setItem("budgetLastModified", new Date().toISOString());
      alert("Budget aggiornato!");
      displayBudget(currentBudgetMonth);
    }
  };

  document.getElementById("prevMonthBtn").onclick = () => {
    currentBudgetMonth = getAdjacentMonth(currentBudgetMonth, -1);
    displayBudget(currentBudgetMonth);
  };
  document.getElementById("nextMonthBtn").onclick = () => {
    currentBudgetMonth = getAdjacentMonth(currentBudgetMonth, 1);
    displayBudget(currentBudgetMonth);
  };
  function getAdjacentMonth(monthYearStr, diff){
    if(!monthYearStr) monthYearStr = getCurrentMonthFormatted().toLowerCase();
    let [mese, anno] = monthYearStr.split(" ");
    let annoNum = parseInt(anno);
    let meseNum = meseToNum(mese);
    meseNum += diff;
    if(meseNum < 1){
      meseNum = 12;
      annoNum--;
    } else if(meseNum > 12){
      meseNum = 1;
      annoNum++;
    }
    const mesi = ["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"];
    return `${mesi[meseNum-1]} ${annoNum}`;
  }

  function getCurrentMonthFormatted() {
    const d = new Date();
    return d.toLocaleDateString("it-IT", {month:"long", year:"numeric"});
  }

  // Inizializzazione pagina
  window.onload = () => {
    document.getElementById("data").value = new Date().toISOString().split('T')[0];
    if(!localStorage.getItem("categorie")) {
      saveCategories(startCategories);
    }
    setCategoryOptions("Uscita");
    document.getElementById("fonte").value = "CONTANTI";
    loadDettaglio();
    calcSaldo();
    currentBudgetMonth = getCurrentMonthFormatted();
    displayBudget(currentBudgetMonth);
    renderCategorie();
  };
</script>

</body>
</html>
