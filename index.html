<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Bilancio Personale Multitab</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; background: #f7f7f7;}
    h1 { text-align: center; }
    nav { margin: 20px 0; }
    nav button { padding:10px 25px;margin-right:5px;font-size:1.1em;border:none;border-radius:6px;cursor:pointer;}
    .active { background: #339cff; color: #fff; }
    section { display:none; padding:16px; background:#fff; border-radius:8px; box-shadow:1px 2px 8px #bbb;}
    section.active { display:block; }
    table { width:100%; margin-top:10px; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:4px; }
    th { background:#eee; }
    label { margin-top: 8px; font-weight: bold; display:block; }
    select, input, button { width: 100%; padding: 10px; margin: 8px 0;}
    .saldo-row { display:flex; gap:25px; margin-bottom:12px; }
    .saldo-box { background:#e3e3e3; border-radius:7px; padding:14px; min-width:140px; font-size:1.2em; text-align:center;}
    .add-btn { background: #33c16c; color: #fff; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; padding:7px 30px;}
    .del-btn { background: #c13333; color:#fff; border:none; border-radius:8px; font-size:1em; cursor:pointer; padding:5px 15px;}
    #budgetCopy { white-space:pre-line; font-family:monospace; background:#f7f7f7; padding:14px; border-radius:7px;} 
  </style>
</head>
<body>
  <h1>Bilancio Personale</h1>
  <nav>
    <button id="btnInput" class="active">Input</button>
    <button id="btnDettaglio">Dettaglio Spese</button>
    <button id="btnBudget">Budget</button>
    <button id="btnCategorie">Categorie</button>
    <button id="btnSaldo">Saldo</button>
  </nav>

  <!-- SALDO -->
  <section id="tabSaldo">
    <h2>Saldo conti</h2>
    <div class="saldo-row">
      <div class="saldo-box" id="saldoContanti">Contanti: €0.00</div>
      <div class="saldo-box" id="saldoRevolut">Revolut: €0.00</div>
      <div class="saldo-box" id="saldoUnicredit">Unicredit: €0.00</div>
      <div class="saldo-box" id="saldoIsybank">Isybank: €0.00</div>
      <div class="saldo-box" style="background:#339cff; color:#fff" id="saldoTotale">Totale: €0.00</div>
    </div>
  </section>

  <!-- Input movimento -->
  <section id="tabInput" class="active">
    <h2>Nuovo Movimento</h2>
    <form id="movForm">
      <label>Tipo</label>
      <select id="tipo" required>
        <option value="Uscita" selected>Uscita</option>
        <option value="Entrata">Entrata</option>
      </select>
      <label>Fonte</label>
      <select id="fonte" required>
        <option value="CONTANTI">CONTANTI</option>
        <option value="REVOLUT">REVOLUT</option>
        <option value="UNICREDIT">UNICREDIT</option>
        <option value="ISYBANK">ISYBANK</option>
      </select>
      <label>Data</label>
      <input type="date" id="data" required>
      <label>Importo (€)</label>
      <input type="number" id="euro" min="0" step="0.01" required>
      <label>Descrizione</label>
      <input type="text" id="descrizione" required>
      <label>Categoria</label>
      <select id="categoria" required></select>
      <button type="submit">Aggiungi</button>
    </form>
  </section>

  <!-- Dettaglio spese -->
  <section id="tabDettaglio">
    <h2>Dettaglio Spese</h2>
    <table id="dettaglioTable">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Fonte</th>
          <th>Data</th>
          <th>Mese</th>
          <th>Anno</th>
          <th>Euro</th>
          <th>Descrizione</th>
          <th>Categoria</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Budget -->
  <section id="tabBudget">
    <h2>Budget</h2>
    <div id="budgetCopy"></div>
  </section>

  <!-- Categorie -->
  <section id="tabCategorie">
    <h2>Categorie</h2>
    <form id="newCatForm">
      <label>Nuova categoria</label>
      <input type="text" id="nuovaCat" placeholder="Nome categoria">
      <select id="catTipo">
        <option value="Uscita">Uscita</option>
        <option value="Entrata">Entrata</option>
      </select>
      <button type="submit" class="add-btn">Aggiungi</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Categoria</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody id="catTabBody"></tbody>
    </table>
  </section>

<script>
const startCategories = {
  Uscita: [
    "TRASPORTI","AFFITTO","UTENZE","SPESA E ALIMENTARI","CURA PERSONALE",
    "SPESE MEDICHE","VESTITI ESSENZIALI","COSE DELLA CASA","SPESE SCOLASTICHE",
    "RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"
  ],
  Entrata: [
    "Lavoro","Mamma","Nonna","Roxana","Entrate extra","Rimborsi"
  ]
};
const contiArr = ["CONTANTI","REVOLUT","UNICREDIT","ISYBANK"];

// Gestione categorie interattive
function loadCategories() {
  let cats = JSON.parse(localStorage.getItem('categorie') || "null");
  return cats || JSON.parse(JSON.stringify(startCategories));
}
function saveCategories(cats) {
  localStorage.setItem('categorie', JSON.stringify(cats));
}
function setCategoryOptions(tipo) {
  let select = document.getElementById('categoria');
  select.innerHTML = '<option value="">Seleziona categoria</option>';
  loadCategories()[tipo].forEach(c => {
    let opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    select.appendChild(opt);
  });
}
document.getElementById('tipo').addEventListener('change', function() {
  setCategoryOptions(this.value);
});

// Gestione saldo
function calcSaldo() {
  let movimenti = JSON.parse(localStorage.getItem('movimenti') || "[]");
  let saldi = {CONTANTI:0, REVOLUT:0, UNICREDIT:0, ISYBANK:0};
  movimenti.forEach(m => {
    if(contiArr.includes(m.fonte)){
      if(m.tipo==="Entrata") saldi[m.fonte] += m.euro;
      else saldi[m.fonte] -= m.euro;
    }
  });
  document.getElementById('saldoContanti').innerHTML = "Contanti: €"+saldi.CONTANTI.toFixed(2);
  document.getElementById('saldoRevolut').innerHTML = "Revolut: €"+saldi.REVOLUT.toFixed(2);
  document.getElementById('saldoUnicredit').innerHTML = "Unicredit: €"+saldi.UNICREDIT.toFixed(2);
  document.getElementById('saldoIsybank').innerHTML = "Isybank: €"+saldi.ISYBANK.toFixed(2);
  let tot = saldi.CONTANTI + saldi.REVOLUT + saldi.UNICREDIT + saldi.ISYBANK;
  document.getElementById('saldoTotale').innerHTML = "Totale: €"+tot.toFixed(2);
}

// Navigazione tab
function showTab(tab) {
  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
  document.getElementById('btn' + tab).classList.add('active');
  document.getElementById('tab' + tab).classList.add('active');
  if(tab==="Saldo"){ calcSaldo(); }
  if(tab==="Dettaglio"){ loadDettaglio(); }
  if(tab==="Budget"){ calcBudgetCopy(); }
  if(tab==="Categorie"){ renderCategorie(); }
}
document.getElementById('btnInput').onclick = () => showTab('Input');
document.getElementById('btnDettaglio').onclick = () => showTab('Dettaglio');
document.getElementById('btnBudget').onclick = () => showTab('Budget');
document.getElementById('btnCategorie').onclick = () => showTab('Categorie');
document.getElementById('btnSaldo').onclick = () => showTab('Saldo');

// All’avvio
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('data').value = new Date().toISOString().split('T')[0];
  if(!localStorage.getItem('categorie')) saveCategories(startCategories);
  setCategoryOptions('Uscita');
  calcSaldo(); loadDettaglio(); calcBudgetCopy(); renderCategorie();
});

// Salva nuovo movimento su localStorage
document.getElementById('movForm').onsubmit = function(e) {
  e.preventDefault();
  let tipo = document.getElementById('tipo').value;
  let fonte = document.getElementById('fonte').value;
  let data = document.getElementById('data').value;
  let euro = parseFloat(document.getElementById('euro').value);
  let descrizione = document.getElementById('descrizione').value;
  let categoria = document.getElementById('categoria').value;
  let dt = new Date(data);
  let mese = dt.toLocaleString('it-IT', { month: 'long' });
  let anno = dt.getFullYear();
  let movimenti = JSON.parse(localStorage.getItem('movimenti') || "[]");
  movimenti.push({tipo, fonte, data, mese, anno, euro, descrizione, categoria});
  localStorage.setItem('movimenti', JSON.stringify(movimenti));
  this.reset();
  document.getElementById('tipo').value = "Uscita";
  setCategoryOptions('Uscita');
  document.getElementById('fonte').value = "CONTANTI";
  document.getElementById('data').value = new Date().toISOString().split('T')[0];
  alert("Movimento inserito!");
  calcSaldo(); loadDettaglio(); calcBudgetCopy();
}

// Dettaglio spese
function loadDettaglio() {
  let tbody = document.querySelector('#dettaglioTable tbody');
  tbody.innerHTML = '';
  let movimenti = JSON.parse(localStorage.getItem('movimenti') || "[]");
  movimenti.forEach(m => {
    let row = `<tr>
      <td>${m.tipo}</td>
      <td>${m.fonte}</td>
      <td>${m.data}</td>
      <td>${m.mese}</td>
      <td>${m.anno}</td>
      <td>€ ${m.euro.toFixed(2)}</td>
      <td>${m.descrizione}</td>
      <td>${m.categoria}</td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

// Budget tab: copia esatta foglio Google (testo)
function calcBudgetCopy() {
  let mov = JSON.parse(localStorage.getItem('movimenti') || "[]");
  let euroAnnualeNec = mov.filter(m=>["TRASPORTI","AFFITTO","UTENZE","SPESA E ALIMENTARI",
    "CURA PERSONALE","SPESE MEDICHE","VESTITI ESSENZIALI","COSE DELLA CASA","SPESE SCOLASTICHE"].includes(m.categoria) && m.tipo==="Uscita")
    .reduce((tot,m)=>tot+m.euro,0);
  let euroAnnualeExtra = mov.filter(m=>["
