<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Bilancio Personale Completo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      background: #f7f7f7;
    }

    h1 {
      text-align: center;
      margin-bottom: 5px;
    }

    #saldoTotaleBar {
      background: #339cff;
      color: white;
      font-weight: bold;
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      margin-bottom: 18px;
      font-size: 1.2em;
      user-select: text;
      position: sticky;
      top: 0;
      z-index: 999;
    }

    nav {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    nav button {
      padding: 10px 25px;
      font-size: 1.1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }

    nav button.active,
    nav button:hover {
      filter: brightness(0.9);
    }

    #btnInput {
      background-color: #c92a2a;
      color: white;
    }

    #btnDettaglio {
      background-color: #d9a620;
      color: #222;
    }

    #btnBudget,
    #btnCategorie {
      background-color: #6c757d;
      color: white;
    }

    #btnSaldo {
      background-color: #339cff;
      color: white;
    }

    section {
      display: none;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 1px 2px 8px #bbb;
      min-height: 320px;
      transition: opacity 0.3s ease;
    }

    section.active {
      display: block;
      opacity: 1;
    }

    label {
      font-weight: bold;
      margin-top: 12px;
      display: block;
    }

    select,
    input,
    button,
    textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
      font-family: inherit;
      resize: vertical;
    }

    button[type='submit'],
    button.edit-btn,
    button.del-btn {
      margin-top: 20px;
      background-color: #777;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
      border-radius: 7px;
      padding: 10px;
      user-select: none;
    }

    button[type='submit']:hover,
    button.edit-btn:hover,
    button.del-btn:hover {
      background-color: #555;
    }

    button.del-btn {
      background-color: #c92a2a;
      margin-left: 5px;
    }

    button.del-btn:hover {
      background-color: #a12424;
    }

    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      user-select: none;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      vertical-align: middle;
      user-select: text;
    }

    th {
      background-color: #eee;
      font-weight: bold;
      user-select: text;
    }

    /* Category colors */
    .essenziale {
      background-color: #ffe5e5;
      color: #b20000;
      font-weight: bold;
    }

    .extra {
      background-color: #fff9e3;
      color: #b38800;
      font-weight: bold;
    }

    .entrata {
      background-color: #eaffea;
      color: #067e15;
      font-weight: bold;
    }

    /* Rows colored */
    tr.essenziale td {
      background-color: #fff2f2;
      color: #a10000;
    }

    tr.extra td {
      background-color: #fffbe6;
      color: #a67c00;
    }

    tr.entrata td {
      background-color: #e7f9e7;
      color: #056605;
    }

    /* Budget editing area */
    #budgetText {
      width: 100%;
      height: 280px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 12px;
      background-color: #f7f7f7;
      user-select: text;
      resize: vertical;
    }

    /* Form within categories */
    #newCatForm {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Bilancio Personale</h1>
  <div id="saldoTotaleBar" aria-live="polite" role="region" aria-label="Saldo totale">Saldo totale: €0.00</div>

  <nav aria-label="Navigazione sezioni">
    <button id="btnInput" class="active" title="Scheda di inserimento dati">Input</button>
    <button id="btnDettaglio" title="Elenco dettagliato movimenti">Dettaglio Spese</button>
    <button id="btnBudget" title="Riepilogo Budget annuale modificabile">Budget</button>
    <button id="btnCategorie" title="Gestione categorie interattiva">Categorie</button>
    <button id="btnSaldo" title="Saldo dei conti dettagliato">Saldo</button>
  </nav>

  <!-- Input movimento -->
  <section id="tabInput" class="active" aria-label="Inserimento nuovo movimento">
    <h2>Nuovo Movimento</h2>
    <form id="movForm" title="Inserisci un nuovo movimento finanziario">
      <label for="tipo">Tipo<span style="color:#b20000;">*</span></label>
      <select id="tipo" required aria-required="true" title="Seleziona Entrata o Uscita">
        <option value="Uscita" selected>Uscita</option>
        <option value="Entrata">Entrata</option>
      </select>

      <label for="fonte">Fonte<span style="color:#b20000;">*</span></label>
      <select id="fonte" required aria-required="true" title="Seleziona la fonte di pagamento o accredito">
        <option value="CONTANTI" selected class="essenziale">CONTANTI</option>
        <option value="REVOLUT" class="essenziale">REVOLUT</option>
        <option value="UNICREDIT" class="essenziale">UNICREDIT</option>
        <option value="ISYBANK" class="essenziale">ISYBANK</option>
      </select>

      <label for="data">Data<span style="color:#b20000;">*</span></label>
      <input type="date" id="data" required aria-required="true" title="Inserisci la data del movimento" />

      <label for="euro">Importo (€)<span style="color:#b20000;">*</span></label>
      <input type="number" id="euro" min="0" step="0.01" required aria-required="true" title="Inserisci l'importo" />

      <label for="descrizione" title="Descrizione facoltativa">Descrizione (facoltativa)</label>
      <input type="text" id="descrizione" aria-required="false" placeholder="Descrizione (opzionale)" title="Puoi aggiungere una descrizione" />

      <label for="categoria">Categoria<span style="color:#b20000;">*</span></label>
      <select id="categoria" required aria-required="true" title="Seleziona la categoria">
        <!-- Popolato da JS -->
      </select>

      <button type="submit" title="Aggiungi il movimento">Aggiungi</button>
    </form>
  </section>

  <!-- Dettaglio spese -->
  <section id="tabDettaglio" aria-label="Dettaglio movimenti">
    <h2>Dettaglio Spese</h2>
    <table id="dettaglioTable" aria-describedby="dettaglioDescr" role="grid" title="Tabella dettagliata movimenti">
      <thead>
        <tr>
          <th scope="col">Tipo</th>
          <th scope="col">Fonte</th>
          <th scope="col">Data</th>
          <th scope="col">Mese</th>
          <th scope="col">Anno</th>
          <th scope="col">Euro</th>
          <th scope="col">Descrizione</th>
          <th scope="col">Categoria</th>
          <th scope="col">Azioni</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="dettaglioDescr" hidden>Tabella dei movimenti dettagliati con tipo, data, importo, descrizione e categoria. È possibile cancellare i movimenti qui.</p>
  </section>

  <!-- Budget -->
  <section id="tabBudget" aria-label="Budget modificabile">
    <h2>Budget</h2>
    <p id="budgetLastMod" style="font-style: italic; font-size: 0.9em; color: #666;"></p>
    <label for="budgetMonth">Mese (es. agosto 2025):</label>
    <input type="text" id="budgetMonth" placeholder="Es. agosto 2025" />
    <label for="budgetText">Modifica il budget qui (testo libero, ogni modifica viene salvata):</label>
    <textarea id="budgetText" aria-live="polite"></textarea>
    <button id="saveBudgetBtn" style="background:#6c757d;color:white;border:none;padding:10px 15px; border-radius:7px; cursor:pointer; margin-top:10px; font-weight:bold;">Salva Budget</button>
  </section>

  <!-- Categorie -->
  <section id="tabCategorie" aria-label="Gestione categorie">
    <h2>Gestione Categorie</h2>
    <form id="newCatForm" aria-label="Aggiungi una nuova categoria">
      <label for="nuovaCat">Nuova categoria<span style="color:#b20000;">*</span></label>
      <input type="text" id="nuovaCat" placeholder="Nome categoria" aria-required="true" />
      <label for="catTipo">Tipo<span style="color:#b20000;">*</span></label>
      <select id="catTipo" aria-required="true" >
        <option value="Uscita">Uscita</option>
        <option value="Entrata">Entrata</option>
      </select>
      <button type="submit" class="add-btn" title="Aggiungi categoria" style="background:#6c757d;color:#fff;padding: 10px 20px;margin-top: 10px;border-radius: 7px;">Aggiungi</button>
    </form>
    <table aria-label="Tabella categorie" role="grid" id="catTable" style="user-select:none;">
      <thead>
        <tr>
          <th scope="col">Tipo</th>
          <th scope="col">Categoria</th>
          <th scope="col">Azioni</th>
        </tr>
      </thead>
      <tbody id="catTabBody"></tbody>
    </table>
  </section>

<script>
  const startCategories = {
    Uscita: [
      "TRASPORTI",
      "AFFITTO",
      "UTENZE",
      "SPESA E ALIMENTARI",
      "CURA PERSONALE",
      "SPESE MEDICHE",
      "VESTITI ESSENZIALI",
      "COSE DELLA CASA",
      "SPESE SCOLASTICHE",
      "RISTORANTE",
      "VACANZA",
      "REGALI",
      "ALTRO EXTRA",
      "USCITE",
      "SIGARETTE"
    ],
    Entrata: [
      "Lavoro",
      "Mamma",
      "Nonna",
      "Roxana",
      "Entrate extra",
      "Rimborsi"
    ]
  };

  const contiArr = ["CONTANTI", "REVOLUT", "UNICREDIT", "ISYBANK"];

  function showTab(tab) {
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('btn' + tab).classList.add('active');
    document.getElementById('tab' + tab).classList.add('active');
    if (tab === "Saldo") calcSaldo();
    else if (tab === "Dettaglio") loadDettaglio();
    else if (tab === "Budget") loadBudget();
    else if (tab === "Categorie") renderCategorie();
  }

  document.getElementById('btnInput').onclick = () => showTab('Input');
  document.getElementById('btnDettaglio').onclick = () => showTab('Dettaglio');
  document.getElementById('btnBudget').onclick = () => showTab('Budget');
  document.getElementById('btnCategorie').onclick = () => showTab('Categorie');
  document.getElementById('btnSaldo').onclick = () => showTab('Saldo');

  function loadCategories() {
    let cats = JSON.parse(localStorage.getItem('categorie') || "null");
    return cats || JSON.parse(JSON.stringify(startCategories));
  }
  function saveCategories(cats) {
    localStorage.setItem('categorie', JSON.stringify(cats));
  }
  function setCategoryOptions(tipo) {
    let select = document.getElementById('categoria');
    select.innerHTML = '<option value="">Seleziona categoria</option>';
    loadCategories()[tipo].forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      // Colori categorie come richiesto
      if (startCategories.Uscita.includes(c)) {
        opt.style.backgroundColor = "#ffe5e5"; // rosso chiaro
        opt.style.color = "#b20000";
      }
      if (startCategories.Entrata.includes(c)) {
        opt.style.backgroundColor = "#eaffea"; // verde
        opt.style.color = "#067e15";
      }
      if (["RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"].includes(c)) {
        opt.style.backgroundColor = "#fff9e3"; // giallo
        opt.style.color = "#b38800";
      }
      select.appendChild(opt);
    });
  }
  document.getElementById('tipo').addEventListener('change', function () {
    setCategoryOptions(this.value);
  });

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('data').value = new Date().toISOString().split('T')[0];
    if (!localStorage.getItem('categorie')) saveCategories(startCategories);
    setCategoryOptions("Uscita");
    document.getElementById('fonte').value = "CONTANTI";
    loadDettaglio();
    calcSaldo();
    loadBudget();
    renderCategorie();
  });

  document.getElementById('movForm').onsubmit = function(e) {
    e.preventDefault();
    let tipo = document.getElementById('tipo').value;
    let fonte = document.getElementById('fonte').value;
    let data = document.getElementById('data').value;
    let euro = parseFloat(document.getElementById('euro').value);
    let descrizione = document.getElementById('descrizione').value || "";
    let categoria = document.getElementById('categoria').value;
    let dt = new Date(data);
    let mese = dt.toLocaleString("it-IT", {month: "long"});
    let anno = dt.getFullYear();

    let movimenti = JSON.parse(localStorage.getItem('movimenti') || "[]");
    movimenti.push({tipo, fonte, data, mese, anno, euro, descrizione, categoria});
    localStorage.setItem('movimenti', JSON.stringify(movimenti));

    this.reset();
    document.getElementById('tipo').value = "Uscita";
    setCategoryOptions("Uscita");
    document.getElementById('fonte').value = "CONTANTI";
    document.getElementById('data').value = new Date().toISOString().split('T')[0];
    alert("Movimento inserito!");
    loadDettaglio();
    calcSaldo();
    loadBudget();
  };

  // Dettaglio spese con eliminazione
  function loadDettaglio() {
    let tbody = document.querySelector('#dettaglioTable tbody');
    tbody.innerHTML = "";
    let movimenti = JSON.parse(localStorage.getItem('movimenti') || "[]");
    movimenti.forEach((m, idx) => {
      let tr = document.createElement("tr");
      let classe = "";
      if (startCategories.Uscita.includes(m.categoria)) classe = 'essenziale';
      else if (startCategories.Entrata.includes(m.categoria)) classe = 'entrata';
      else if (["RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"].includes(m.categoria)) classe = 'extra';

      tr.className = classe;
      tr.innerHTML = `
        <td>${m.tipo}</td>
        <td>${m.fonte}</td>
        <td>${m.data}</td>
        <td>${m.mese}</td>
        <td>${m.anno}</td>
        <td>€ ${m.euro.toFixed(2)}</td>
        <td>${m.descrizione}</td>
        <td>${m.categoria}</td>
        <td><button class="del-btn" aria-label="Elimina movimento" data-idx="${idx}">Elimina</button></td>
      `;
      tbody.appendChild(tr);
    });
    // delete buttons listeners
    tbody.querySelectorAll('.del-btn').forEach(btn => {
      btn.onclick = function () {
        let idx = parseInt(this.dataset.idx);
        let movimenti = JSON.parse(localStorage.getItem('movimenti') || "[]");
        movimenti.splice(idx, 1);
        localStorage.setItem('movimenti', JSON.stringify(movimenti));
        loadDettaglio();
        calcSaldo();
        loadBudget();
      };
    });
  }

  // Saldo calcolo e visualizzazione sempre aggiornata
  function calcSaldo() {
    let movimenti = JSON.parse(localStorage.getItem('movimenti') || "[]");
    let saldi = {CONTANTI:0, REVOLUT:0, UNICREDIT:0, ISYBANK:0};
    movimenti.forEach(m => {
      if(contiArr.includes(m.fonte)) {
        if(m.tipo==="Entrata") saldi[m.fonte] += m.euro;
        else saldi[m.fonte] -= m.euro;
      }
    });
    document.getElementById('saldoTotaleBar').textContent = "Saldo totale: €" 
      + (saldi.CONTANTI + saldi.REVOLUT + saldi.UNICREDIT + saldi.ISYBANK).toFixed(2);
    document.getElementById('saldoContanti').textContent = "Contanti: €"+saldi.CONTANTI.toFixed(2);
    document.getElementById('saldoRevolut').textContent = "Revolut: €"+saldi.REVOLUT.toFixed(2);
    document.getElementById('saldoUnicredit').textContent = "Unicredit: €"+saldi.UNICREDIT.toFixed(2);
    document.getElementById('saldoIsybank').textContent = "Isybank: €"+saldi.ISYBANK.toFixed(2);
  }

  // Budget modificabile con data e mese
  function loadBudget() {
    let budgetText = localStorage.getItem('budgetText') || "Inserisci qui i dati del budget...";
    let budgetMonth = localStorage.getItem('budgetMonth') || "";
    let budgetDate = localStorage.getItem('budgetDate') || null;
    document.getElementById('budgetText').value = budgetText;
    document.getElementById('budgetMonth').value = budgetMonth;
    if(budgetDate) {
      document.getElementById('budgetLastMod').textContent = "Ultima modifica: " + new Date(budgetDate).toLocaleString();
    } else {
      document.getElementById('budgetLastMod').textContent = "Nessuna modifica salvata";
    }
  }

  // Salva budget
  document.getElementById('saveBudgetBtn').addEventListener('click', () => {
    localStorage.setItem('budgetText', document.getElementById('budgetText').value);
    localStorage.setItem('budgetMonth', document.getElementById('budgetMonth').value);
    localStorage.setItem('budgetDate', new Date().toISOString());
    loadBudget();
    alert("Budget salvato!");
  });

  // Categorie UI
  function renderCategorie() {
    const tbody = document.getElementById('catTabBody');
    tbody.innerHTML = "";
    const cats = loadCategories();
    ['Uscita', 'Entrata'].forEach(tipo => {
      cats[tipo].forEach((cat, idx) => {
        const tr = document.createElement('tr');
        let bgColor = '';
        let fgColor = '';
        if (startCategories.Uscita.includes(cat)) { bgColor = '#ffe5e5'; fgColor = '#b20000'; }
        else if (startCategories.Entrata.includes(cat)) { bgColor = '#eaffea'; fgColor = '#067e15'; }
        if (["RISTORANTE", "VACANZA", "REGALI", "ALTRO EXTRA", "USCITE", "SIGARETTE"].includes(cat)) { bgColor = '#fff9e3'; fgColor = '#b38800'; }

        tr.style.backgroundColor = bgColor;
        tr.style.color = fgColor;

        tr.innerHTML = `
          <td>${tipo}</td>
          <td>${cat}</td>
          <td><button class="del-btn" title="Elimina categoria" data-tipo="${tipo}" data-index="${idx}">Elimina</button></td>
        `;
        tbody.appendChild(tr);
      });
    });
    tbody.querySelectorAll('.del-btn').forEach(btn => {
      btn.onclick = function () {
        const tipo = this.dataset.tipo;
        const idx = parseInt(this.dataset.index);
        const cats = loadCategories();
        cats[tipo].splice(idx, 1);
        saveCategories(cats);
        renderCategorie();
        setCategoryOptions(document.getElementById('tipo').value);
      };
    });
  }

  // Aggiungi categoria
  document.getElementById('newCatForm').onsubmit = function (e) {
    e.preventDefault();
    const nuovaCat = document.getElementById('nuovaCat').value.trim();
    const tipo = document.getElementById('catTipo').value;
    if (!nuovaCat) { alert('Inserisci il nome della categoria'); return; }
    const cats = loadCategories();
    if (cats[tipo].includes(nuovaCat)) { alert('Categoria già presente'); return; }
    cats[tipo].push(nuovaCat);
    saveCategories(cats);
    renderCategorie();
    setCategoryOptions(document.getElementById('tipo').value);
    document.getElementById('nuovaCat').value = '';
    alert('Categoria aggiunta!');
  };
</script>
</body>
</html>
