<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Budget Personale con Gestione Avanzata</title>
<style>
  /* (Qui usarebbe lo stesso css della versione precedente, con eventuale piccola aggiunta per modale o area modifica budget) */
  body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; background: #f7f7f7; }
  #saldoBar { ... } /* come saldoBar prima */
  /* aggiungere styling per modale budget edit */
  #budgetEditModal {
    position: fixed; top: 0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5);
    display:none; justify-content:center; align-items:center; z-index: 1000;
  }
  #budgetEditContent {
    background: white; padding:20px; border-radius:8px; width: 80%; max-width: 600px;
  }
  #budgetEditContent textarea, #budgetEditContent input {
    width: 100%; margin-bottom: 10px; font-family: monospace; font-size: 14px;
    resize: vertical; height: 150px;
  }
  #budgetEditContent button { margin-right: 10px; }
</style>
</head>
<body>

<div id="saldoBar" aria-live="polite">Saldo totale: €0.00</div>
<nav>
  <!-- Bottoni uguali -->
</nav>

<!-- ALTRE SEZIONI COME PRIMA -->

<section id="tabBudget" aria-label="Budget">
  <h2>Budget</h2>
  <p id="budgetMonthDisplay"></p>
  <div>
    <button id="btnEditBudget">Modifica Budget</button>
  </div>
  
  <table id="budgetTable" border="1" style="width:100%; margin-top:10px;">
    <thead>
      <tr>
        <th>Categoria</th><th>Budget Iniziale (€)</th><th>Spese (€)</th><th>Rimanente (€)</th>
      </tr>
    </thead>
    <tbody>
      <!-- Generato dinamicamente -->
    </tbody>
  </table>
</section>

<div id="budgetEditModal" role="dialog" aria-modal="true" aria-labelledby="budgetEditTitle">
  <div id="budgetEditContent">
    <h3 id="budgetEditTitle">Modifica Budget per Mese</h3>
    <label for="editBudgetMonth">Mese (es: agosto 2025):</label>
    <input type="text" id="editBudgetMonth" />
    <label for="editBudgetText">Budget JSON (forma: {"categoria": importo, ...} ):</label>
    <textarea id="editBudgetText"></textarea>
    <br />
    <button id="saveBudgetEdit">Salva</button>
    <button id="cancelBudgetEdit">Annulla</button>
  </div>
</div>

<script>
const budgetKeyPrefix = "budget_"; // per ogni mese un key tipo "budget_agosto2025"
const currentMonthFormatted = new Date().toLocaleDateString("it-IT",{year:"numeric",month:"long"});
// esempio: "agosto 2025"

document.getElementById("budgetMonthDisplay").textContent = currentMonthFormatted;

document.getElementById("btnEditBudget").addEventListener("click", () => {
  // Apri modale budget edit
  let month = prompt("Inserisci mese per modificare (es: agosto 2025):", currentMonthFormatted);
  if(!month) return;
  month = month.trim().toLowerCase();

  let currentBudget = localStorage.getItem(budgetKeyPrefix + month) || "{}";
  document.getElementById("editBudgetMonth").value = month;
  document.getElementById("editBudgetText").value = currentBudget;

  document.getElementById("budgetEditModal").style.display = "flex";
});

// Chiudi modale
document.getElementById("cancelBudgetEdit").addEventListener("click", () => {
  document.getElementById("budgetEditModal").style.display = "none";
});

// Salva modale
document.getElementById("saveBudgetEdit").addEventListener("click", () => {
  if(confirm("Sei sicuro di salvare il budget modificato?")) {
    let month = document.getElementById("editBudgetMonth").value.trim().toLowerCase();
    let text = document.getElementById("editBudgetText").value.trim();

    try {
      JSON.parse(text); // verifica json valido
    } catch(e){
      alert("Errore: JSON non valido");
      return;
    }

    localStorage.setItem(budgetKeyPrefix + month, text);
    localStorage.setItem("budgetLastModified", new Date().toISOString());
    alert("Budget salvato per " + month);
    document.getElementById("budgetEditModal").style.display = "none";
    loadBudget();
  }
});

function loadBudget(){
  let month = document.getElementById("budgetMonth").value || currentMonthFormatted;
  month = month.trim().toLowerCase();
  document.getElementById("budgetMonth").value = month;
  
  let budgetJSON = localStorage.getItem(budgetKeyPrefix + month) || "{}";
  let budgetData;
  try {
    budgetData = JSON.parse(budgetJSON);
  } catch(e) {
    budgetData = {};
  }
  document.getElementById("budgetText").value = JSON.stringify(budgetData, null, 2);

  let lastMod = localStorage.getItem("budgetLastModified");
  if(lastMod){
    document.getElementById("budgetMonthDisplay").textContent = "Mese: " + capitalize(month) + " - Ultima modifica: " + new Date(lastMod).toLocaleString();
  } else {
    document.getElementById("budgetMonthDisplay").textContent = "Mese: " + capitalize(month) + " - Nessuna modifica salvata";
  }

  updateBudgetTable(budgetData, month);
}

// Aggiorna tabella budget con spese
function updateBudgetTable(budgetData, month){
  const tbody = document.querySelector("#budgetTable tbody");
  tbody.innerHTML = "";

  let movs = JSON.parse(localStorage.getItem("movimenti")||"[]");
  // Filtra movimenti per mese e anno corrispondente al mese selezionato
  let [mesename, year] = month.split(" ");
  year = parseInt(year);

  movs = movs.filter(m => {
    let dm = m.mese.toLowerCase();
    let da = m.anno;
    return dm === mesename && da === year;
  });

  // Calcola spese per categoria (solo uscite)
  let expenseMap = {};
  movs.forEach(m => {
    if(m.tipo === "Uscita"){
      expenseMap[m.categoria] = (expenseMap[m.categoria]||0) + m.euro;
    }
  });

  for(let cat in budgetData){
    const budg = parseFloat(budgetData[cat]) || 0;
    const spent = expenseMap[cat] || 0;
    const remaining = budg - spent;

    // Eventuale classe colore in tabella
    let trClass = "";
    if (startBudgetCats.essenziali.includes(cat)) trClass = "essenziale";
    else if (startBudgetCats.extra.includes(cat)) trClass = "extra";
    else if (startBudgetCats.entrate.includes(cat)) trClass = "entrata";

    let tr = document.createElement("tr");
    tr.className = trClass;
    tr.innerHTML = `
      <td>${cat}</td>
      <td>€ ${budg.toFixed(2)}</td>
      <td>€ ${spent.toFixed(2)}</td>
      <td>€ ${remaining.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  }
}

const startBudgetCats={
  essenziali:["trasporti","affitto","utenze","spesa e alimentari","cura personale","spese mediche","vestiti essenziali","cose della casa","spese scolastiche"],
  extra:["ristorante","vacanza","regali","altro extra","uscite","sigarette"],
  entrate:["lavoro","mamma","nonna","roxana","entrate extra","rimborsi"]
}

function capitalize(str){
  if(!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}
</script>

</body></html>

