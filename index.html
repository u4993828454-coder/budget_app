<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Bilancio Personale Completo con Budget Interattivo</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 1000px;
    margin: 20px auto;
    background: #f7f7f7;
  }
  h1 {
    text-align: center;
    margin-bottom: 5px;
  }
  #saldoTotaleBar {
    position: sticky;
    top: 0;
    background: #339cff;
    color: white;
    font-weight: bold;
    padding: 15px;
    font-size: 1.3em;
    text-align:center;
    border-radius: 0 0 8px 8px;
    margin-bottom: 18px;
    z-index: 1000;
  }
  nav {
    margin: 20px 0;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }
  nav button {
    padding: 10px 25px;
    font-size: 1.1em;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: filter 0.3s ease;
  }
  nav button.active,
  nav button:hover {
    filter: brightness(0.85);
  }
  #btnInput { background-color: #c92a2a; color: white; }
  #btnDettaglio { background-color: #d9a620; color: #222; }
  #btnBudget, #btnCategorie { background-color: #6c757d; color: white; }
  #btnSaldo { background-color: #339cff; color: white; }
  
  section {
    display: none;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 1px 2px 8px #bbb;
    min-height: 320px;
    transition: opacity 0.3s ease;
  }
  section.active {
    display: block;
    opacity: 1;
  }
  label {
    font-weight: bold;
    margin-top: 12px;
    display: block;
  }
  select, input, button, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
    font-family: inherit;
    resize: vertical;
  }
  button[type='submit'], button.del-btn, button.budgetDel {
    margin-top: 20px;
    border: none;
    border-radius: 7px;
    cursor: pointer;
    font-weight: bold;
    padding: 10px;
    user-select: none;
  }
  button[type='submit'], #saveBudgetBtn, #budgetAddBtn {
    background-color: #6c757d;
    color: white;
  }
  button[type='submit']:hover, button.del-btn:hover, button.budgetDel:hover, #saveBudgetBtn:hover, #budgetAddBtn:hover {
    filter: brightness(0.85);
  }
  button.del-btn, button.budgetDel {
    background-color: #c92a2a;
    color: white;
    padding: 6px 14px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    user-select: none;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
    vertical-align: middle;
    user-select: text;
  }
  th {
    background-color: #eee;
    font-weight: bold;
    user-select: text;
  }
  option.essenziale {
    background-color: #ffe5e5 !important;
    color: #b20000 !important;
    font-weight: bold;
  }
  option.extra {
    background-color: #fff9e3 !important;
    color: #b38800 !important;
    font-weight: bold;
  }
  option.entrata {
    background-color: #eaffea !important;
    color: #067e15 !important;
    font-weight: bold;
  }
  tr.essenziale td {
    background-color: #fff2f2;
    color: #a10000;
  }
  tr.extra td {
    background-color: #fffbe6;
    color: #a67c00;
  }
  tr.entrata td {
    background-color: #e7f9e7;
    color: #056605;
  }
  .saldo-box {
    padding: 15px;
    border-radius: 7px;
    min-width: 140px;
    font-weight: bold;
    color: #333;
  }
  .essenzialeSaldo { background: #ffe5e5; color: #b20000; }
  .extraSaldo { background: #fff9e3; color: #a97400; }
  .entrataSaldo { background: #e7f9e7; color: #056605; }
  #budgetMonth {
    margin-top: 10px;
    margin-bottom: 6px;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1em;
    width: 100%;
    box-sizing: border-box;
  }
  #budgetTableContainer {
    margin-top: 10px;
  }
</style>
</head>
<body>

<h1>Bilancio Personale</h1>
<div id="saldoTotaleBar" aria-live="polite" role="region" aria-label="Saldo totale">Saldo totale: €0.00</div>

<nav aria-label="Navigazione">
  <button id="btnInput" class="active" title="Inserimento nuovo movimento">Input</button>
  <button id="btnDettaglio" title="Dettaglio movimenti">Dettaglio</button>
  <button id="btnBudget" title="Gestisci Budget">Budget</button>
  <button id="btnCategorie" title="Gestione Categorie">Categorie</button>
  <button id="btnSaldo" title="Visualizza saldo conti">Saldo</button>
</nav>

<section id="tabInput" class="active" aria-label="Inserimento nuovo movimento">
  <h2>Nuovo Movimento</h2>
  <form id="movForm">
    <label for="tipo">Tipo<span style="color:#b20000;">*</span></label>
    <select id="tipo" required aria-required="true" title="Tipo di movimento">
      <option value="Uscita" selected>Uscita</option>
      <option value="Entrata">Entrata</option>
    </select>

    <label for="fonte">Fonte<span style="color:#b20000;">*</span></label>
    <select id="fonte" required aria-required="true" title="Fonte contabile">
      <option value="CONTANTI" class="essenziale" selected>CONTANTI</option>
      <option value="REVOLUT" class="essenziale">REVOLUT</option>
      <option value="UNICREDIT" class="essenziale">UNICREDIT</option>
      <option value="ISYBANK" class="essenziale">ISYBANK</option>
      <option value="BANCO SANTANDER" class="essenziale">BANCO SANTANDER</option>
    </select>

    <label for="data">Data<span style="color:#b20000;">*</span></label>
    <input type="date" id="data" required aria-required="true" title="Data movimento" />

    <label for="euro">Importo (€)<span style="color:#b20000;">*</span></label>
    <input type="number" id="euro" min="0" step="0.01" required aria-required="true" title="Importo in euro" />

    <label for="descrizione">Descrizione (facoltativa)</label>
    <input type="text" id="descrizione" placeholder="Descrizione (opzionale)" aria-required="false" />

    <label for="categoria">Categoria<span style="color:#b20000;">*</span></label>
    <select id="categoria" required aria-required="true" title="Seleziona categoria"></select>

    <button type="submit">Aggiungi</button>
  </form>
</section>

<section id="tabDettaglio" aria-label="Dettaglio movimenti">
  <h2>Dettaglio Movimenti</h2>
  <table id="dettaglioTable" aria-describedby="dettaglioDescr" role="grid">
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Fonte</th>
        <th>Data</th>
        <th>Mese</th>
        <th>Anno</th>
        <th>Euro</th>
        <th>Descrizione</th>
        <th>Categoria</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p id="dettaglioDescr" hidden>Movimenti divisi per mese con possibilità di cancellazione.</p>
</section>

<section id="tabBudget" aria-label="Budget per categoria e mese">
  <h2>Budget per Categoria e Mese</h2>
  <label for="budgetMonth">Mese (es. agosto 2025)</label>
  <input type="text" id="budgetMonth" placeholder="Es. agosto 2025" />
  <button id="refreshBudgetBtn" style="margin-top:8px; background:#6c757d;color:#fff;padding:8px;border:none;border-radius:6px;cursor:pointer;">Mostra Budget</button>
  <div id="budgetTableContainer" style="margin-top:15px;">
    <table id="budgetTable" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr><th>Categoria</th><th>Budget (€)</th><th>Spese (€)</th><th>Rimanente (€)</th><th>% Usato</th><th>Modifica</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<section id="tabCategorie" aria-label="Gestione categorie">
  <h2>Gestione Categorie</h2>
  <form id="newCatForm">
    <label for="nuovaCat">Nuova categoria<span style="color:#b20000;">*</span></label>
    <input type="text" id="nuovaCat" aria-required="true" autocomplete="off" />
    <label for="catTipo">Tipo<span style="color:#b20000;">*</span></label>
    <select id="catTipo" aria-required="true">
      <option value="Uscita">Uscita</option>
      <option value="Entrata">Entrata</option>
    </select>
    <button type="submit">Aggiungi</button>
  </form>
  <table id="catTable" aria-label="Tabella categorie" style="width:100%; border-collapse:collapse; margin-top:15px;">
    <thead><tr><th>Tipo</th><th>Categoria</th><th>Azioni</th></tr></thead>
    <tbody id="catTabBody"></tbody>
  </table>
</section>

<section id="tabSaldo" aria-label="Saldo conti">
  <h2>Saldo Conti</h2>
  <div style="display:flex; gap:20px; flex-wrap: wrap;">
    <div class="saldo-box essenzialeSaldo" id="saldoContanti">Contanti: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoRevolut">Revolut: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoUnicredit">Unicredit: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoIsybank">Isybank: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoSantander">Banco Santander: €0.00</div>
  </div>
</section>

<script>
  const startCategories = {
    Uscita: ["TRASPORTI","AFFITTO","UTENZE","SPESA E ALIMENTARI","CURA PERSONALE","SPESE MEDICHE",
             "VESTITI ESSENZIALI","COSE DELLA CASA","SPESE SCOLASTICHE","RISTORANTE","VACANZA", "REGALI",
             "ALTRO EXTRA","USCITE","SIGARETTE"],
    Entrata: ["Lavoro","Mamma","Nonna","Roxana","Entrate extra","Rimborsi"]
  };
  const contiArr = ["CONTANTI", "REVOLUT", "UNICREDIT", "ISYBANK", "BANCO SANTANDER"];

  // Salva budget per mese come oggetto {categoria: valore}
  function getBudget(month) {
    let b = localStorage.getItem('budget_'+month.toLowerCase());
    return b ? JSON.parse(b) : {};
  }
  function setBudget(month, budgetObj) {
    localStorage.setItem('budget_'+month.toLowerCase(), JSON.stringify(budgetObj));
    localStorage.setItem('budgetLastModified', new Date().toISOString());
  }

  // Utility
  function capitalize(str) {
    if(!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function loadCategories(){
    let cats=JSON.parse(localStorage.getItem("categorie")||null);
    return cats||JSON.parse(JSON.stringify(startCategories));
  }
  function saveCategories(cats){
    localStorage.setItem("categorie", JSON.stringify(cats));
  }

  function setCategoryOptions(tipo){
    let select = document.getElementById('categoria');
    select.innerHTML = '<option value="">Seleziona categoria</option>';
    let cats = loadCategories()[tipo];
    cats.forEach(c=>{
      let opt=document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      if(startCategories.Uscita.includes(c)){
        opt.className = "essenziale";
      } else if( startCategories.Entrata.includes(c)){
        opt.className = "entrata";
      }
      if(["RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"].includes(c)){
        opt.className = "extra";
      }
      select.appendChild(opt);
    });
  }

  document.getElementById('tipo').addEventListener('change', e => setCategoryOptions(e.target.value));

  // Tabs
  function showTab(tab) {
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById('btn'+tab).classList.add('active');
    document.getElementById('tab'+tab).classList.add('active');
    if(tab === 'Saldo') calcSaldo();
    if(tab === 'Dettaglio') loadDettaglio();
    if(tab === 'Budget') displayBudget();
    if(tab === 'Categorie') renderCategorie();
  }

  document.getElementById('btnInput').onclick = () => showTab('Input');
  document.getElementById('btnDettaglio').onclick = () => showTab('Dettaglio');
  document.getElementById('btnBudget').onclick = () => showTab('Budget');
  document.getElementById('btnCategorie').onclick = () => showTab('Categorie');
  document.getElementById('btnSaldo').onclick = () => showTab('Saldo');

  // Movimento - insert
  document.getElementById('movForm').onsubmit = e => {
    e.preventDefault();
    let tipo = document.getElementById('tipo').value;
    let fonte = document.getElementById('fonte').value;
    let data = document.getElementById('data').value;
    let euro = parseFloat(document.getElementById('euro').value);
    let descrizione = document.getElementById('descrizione').value || '';
    let categoria = document.getElementById('categoria').value;
    if(!categoria){
      alert("Seleziona categoria");
      return;
    }
    let dt = new Date(data);
    let mese = dt.toLocaleDateString('it-IT', {month: 'long'});
    let anno = dt.getFullYear();

    let movs = JSON.parse(localStorage.getItem('movimenti')||'[]');
    movs.push({tipo, fonte, data, euro, descrizione, categoria, mese, anno});
    localStorage.setItem('movimenti', JSON.stringify(movs));
    loadDettaglio();
    calcSaldo();
    resetForm();
    displayBudget();
  };

  function resetForm(){
    document.getElementById('movForm').reset();
    document.getElementById('tipo').value = 'Uscita';
    setCategoryOptions('Uscita');
    document.getElementById('fonte').value = 'CONTANTI';
    document.getElementById('data').value = new Date().toISOString().split('T')[0];
  }

  // Dettaglio movimenti raggruppato per mese
  function loadDettaglio(){
    const tbody = document.querySelector("#dettaglioTable tbody");
    tbody.innerHTML = '';
    let movs = JSON.parse(localStorage.getItem('movimenti')||'[]');
    if(!movs.length) return;
    let groups = {};
    movs.forEach(m => {
      let key = m.anno + '-' + m.mese.toLowerCase();
      if(!groups[key]) groups[key] = [];
      groups[key].push(m);
    });
    let keys = Object.keys(groups);
    keys.sort((a,b) => {
      const [yA,mA] = a.split('-');
      const [yB,mB] = b.split('-');
      let dateA = new Date(yA, meseToNum(mA)-1);
      let dateB = new Date(yB, meseToNum(mB)-1);
      return dateA - dateB;
    });

    keys.forEach(key => {
      const [anno, mese] = key.split('-').reverse();
      const trHeader = document.createElement('tr');
      trHeader.className = 'month-header';
      trHeader.innerHTML = `<td colspan="9">${capitalize(mese)} ${anno}</td>`;
      tbody.appendChild(trHeader);

      groups[key].forEach(m => {
        const tr = document.createElement('tr');
        let cls = '';
        if(startCategories.Uscita.includes(m.categoria)) cls = 'essenziale';
        else if(startCategories.Entrata.includes(m.categoria)) cls = 'entrata';
        else if(["RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"].includes(m.categoria)) cls = 'extra';
        tr.className = cls;
        tr.innerHTML = `
          <td>${m.tipo}</td>
          <td>${m.fonte}</td>
          <td>${m.data}</td>
          <td>${m.mese}</td>
          <td>${m.anno}</td>
          <td>€ ${m.euro.toFixed(2)}</td>
          <td>${m.descrizione}</td>
          <td>${m.categoria}</td>
          <td><button class="del-btn" aria-label="Elimina movimento">Elimina</button></td>
        `;
        tbody.appendChild(tr);
        tr.querySelector('.del-btn').onclick = () => {
          const idx = movs.indexOf(m);
          if(idx >-1){
            movs.splice(idx,1);
            localStorage.setItem('movimenti', JSON.stringify(movs));
            loadDettaglio();
            calcSaldo();
            displayBudget();
          }
        };
      });
    });
  }
  function meseToNum(mese){
    const mesi = {gennaio:1,febbraio:2,marzo:3,aprile:4,maggio:5,giugno:6,luglio:7,agosto:8,settembre:9,ottobre:10,novembre:11,dicembre:12};
    return mesi[mese]||0;
  }
  function capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1);}

  // Calcolo saldo aggiornato
  function calcSaldo(){
    let movs = JSON.parse(localStorage.getItem('movimenti')||'[]');
    let saldo = {CONTANTI:0, REVOLUT:0, UNICREDIT:0, ISYBANK:0, 'BANCO SANTANDER':0};
    movs.forEach(m => {
      if(contiArr.includes(m.fonte)){
        if(m.tipo === 'Entrata') saldo[m.fonte] += m.euro;
        else saldo[m.fonte] -= m.euro;
      }
    });
    document.getElementById('saldoTotaleBar').textContent = `Saldo totale: €${Object.values(saldo).reduce((a,b)=>a+b,0).toFixed(2)}`;
    document.getElementById('saldoContanti').textContent = `Contanti: €${saldo.CONTANTI.toFixed(2)}`;
    document.getElementById('saldoRevolut').textContent = `Revolut: €${saldo.REVOLUT.toFixed(2)}`;
    document.getElementById('saldoUnicredit').textContent = `Unicredit: €${saldo.UNICREDIT.toFixed(2)}`;
    document.getElementById('saldoIsybank').textContent = `Isybank: €${saldo.ISYBANK.toFixed(2)}`;
    document.getElementById('saldoSantander').textContent = `Banco Santander: €${saldo['BANCO SANTANDER'].toFixed(2)}`;
  }

  // --- BUDGET SEZIONE ---
  function displayBudget(){
    let month = document.getElementById('budgetMonth').value.trim().toLowerCase();
    if(!month) return alert('Inserisci un mese (es. agosto 2025)');
    let budget = localStorage.getItem(`budget_${month}`);
    if(!budget) budget = '{}';
    let budgetObj = JSON.parse(budget);
    const movs = JSON.parse(localStorage.getItem('movimenti')||'[]');
    // calcolo spese per categoria nel mese selezionato
    let expenses = {};
    const [meseNome, annoAnno] = month.split(' ');
    const annoInt = parseInt(annoAnno);
    movs.forEach(m => {
      if(m.tipo==='Uscita' && m.mese.toLowerCase()===meseNome && m.anno===annoInt){
        expenses[m.categoria] = (expenses[m.categoria]||0) + m.euro;
      }
    });

    const tbody = document.querySelector('#budgetTable tbody');
    tbody.innerHTML = '';
    for(const cat in budgetObj){
      let budg = parseFloat(budgetObj[cat]);
      if(isNaN(budg)) budg = 0;
      const spent = expenses[cat] || 0;
      const remain = budg - spent;
      const percent = budg>0 ? (spent / budg)*100 : 0;
      let rowClass = '';
      if(startCategories.Uscita.includes(cat)) rowClass = 'essenziale';
      else if(startCategories.Entrata.includes(cat)) rowClass = 'entrata';
      else if(["RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"].includes(cat)) rowClass = 'extra';

      const tr = document.createElement('tr');
      tr.className = rowClass;
      tr.innerHTML = `<td>${cat}</td><td>€ ${budg.toFixed(2)}</td><td>€ ${spent.toFixed(2)}</td><td>€ ${remain.toFixed(2)}</td><td>${percent.toFixed(1)}%</td><td><button class="budgetDel" data-cat="${cat}" data-month="${month}">Elimina</button></td>`;
      tbody.appendChild(tr);
    }

    // elimina budget categoria
    tbody.querySelectorAll('button.budgetDel').forEach(btn=>{
      btn.onclick = () => {
        if(confirm(`Sei sicuro di eliminare il budget per categoria "${btn.dataset.cat}" nel mese "${btn.dataset.month}"?`)){
          let budg = JSON.parse(localStorage.getItem(`budget_${btn.dataset.month}`)|| '{}');
          delete budg[btn.dataset.cat];
          localStorage.setItem(`budget_${btn.dataset.month}`, JSON.stringify(budg));
          displayBudget();
        }
      }
    });
  }

  document.getElementById('refreshBudgetBtn').onclick = displayBudget;

  // aggiunta/modifica budget categoria
  // useremo la form Categorie per aggiungere nuove categorie (con importo da modificare nel budget)
  // aggiungiamo una input per importo budget alla form Categorie
</script>

<section id="budgetAddContainer" style="margin-top:20px; padding:10px; border:1px solid #ccc; border-radius:8px; max-width:600px; margin-left:auto; margin-right:auto;">
  <h3>Aggiungi/Modifica Budget Categoria</h3>
  <label for="budgetCat">Categoria:</label>
  <input type="text" id="budgetCat" placeholder="Nome categoria" autocomplete="off"/>
  <label for="budgetVal">Valore Budget (€):</label>
  <input type="number" id="budgetVal" min="0" step="0.01" />
  <label for="budgetMes">Mese (es. agosto 2025):</label>
  <input type="text" id="budgetMes" placeholder="es. agosto 2025" />
  <button id="budgetAddBtn">Aggiungi/Modifica Budget</button>
</section>

<script>
  document.getElementById('budgetAddBtn').onclick = () =>{
    const cat = document.getElementById('budgetCat').value.trim();
    const val = parseFloat(document.getElementById('budgetVal').value);
    const mes = document.getElementById('budgetMes').value.trim().toLowerCase();
    if(!cat || !mes || isNaN(val)){
      return alert("Inserisci categoria, mese e valore budget validi.");
    }
    let budget = JSON.parse(localStorage.getItem(`budget_${mes}`) || '{}');
    budget[cat] = val;
    localStorage.setItem(`budget_${mes}`, JSON.stringify(budget));
    localStorage.setItem('budgetLastModified', new Date().toISOString());
    alert(`Budget per '${cat}' inserito/modificato per ${mes}.`);
    displayBudget();
  }
</script>

<section id="tabSaldo" aria-label="Saldo conti">
  <h2>Saldo Conti</h2>
  <div style="display:flex; gap:20px; flex-wrap: wrap;">
    <div class="saldo-box essenzialeSaldo" id="saldoContanti">Contanti: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoRevolut">Revolut: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoUnicredit">Unicredit: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoIsybank">Isybank: €0.00</div>
    <div class="saldo-box extraSaldo" id="saldoSantander">Banco Santander: €0.00</div>
  </div>
</section>

<script>
  // Saldo aggiornato con Banco Santander incluso
  function calcSaldo(){
    let movs = JSON.parse(localStorage.getItem('movimenti')||'[]');
    let saldo = {CONTANTI:0, REVOLUT:0, UNICREDIT:0, ISYBANK:0, 'BANCO SANTANDER':0};
    movs.forEach(m => {
      if(contiArr.includes(m.fonte)){
        if(m.tipo === 'Entrata') saldo[m.fonte]+=m.euro;
        else saldo[m.fonte]-=m.euro;
      }
    });
    document.getElementById('saldoTotaleBar').textContent = `Saldo totale: €${Object.values(saldo).reduce((a,b) => a+b, 0).toFixed(2)}`;
    document.getElementById('saldoContanti').textContent = `Contanti: €${saldo.CONTANTI.toFixed(2)}`;
    document.getElementById('saldoRevolut').textContent = `Revolut: €${saldo.REVOLUT.toFixed(2)}`;
    document.getElementById('saldoUnicredit').textContent = `Unicredit: €${saldo.UNICREDIT.toFixed(2)}`;
    document.getElementById('saldoIsybank').textContent = `Isybank: €${saldo.ISYBANK.toFixed(2)}`;
    document.getElementById('saldoSantander').textContent = `Banco Santander: €${saldo['BANCO SANTANDER'].toFixed(2)}`;
  }
</script>

<script>
  // Caricamenti e inizializzazioni
  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('data').value = new Date().toISOString().split('T')[0];
    if(!localStorage.getItem('categorie')) saveCategories(startCategories);
    setCategoryOptions('Uscita');
    document.getElementById('fonte').value = 'CONTANTI';
    loadDettaglio();
    calcSaldo();
    loadBudget();
    renderCategorie();
  });

  // Gestione categorie tab
  function renderCategorie(){
    const tbody = document.getElementById('catTabBody');
    tbody.innerHTML = '';
    const cats = loadCategories();
    ['Uscita','Entrata'].forEach(tipo=>{
      cats[tipo].forEach((cat,i)=>{
        let tr = document.createElement('tr');
        let bg = '', fg = '';
        if(startCategories.Uscita.includes(cat)){ bg = '#ffe5e5'; fg='#b20000'; }
        else if(startCategories.Entrata.includes(cat)){ bg = '#d8fbe0'; fg='#056005'; }
        if(['RISTORANTE','VACANZA','REGALI','ALTRO EXTRA','USCITE','SIGARETTE'].includes(cat)){
          bg = '#fff9d4'; fg = '#a97400';
        }
        tr.style.backgroundColor = bg;
        tr.style.color = fg;
        tr.innerHTML = `<td>${tipo}</td><td>${cat}</td><td><button class="del-btn" data-tipo="${tipo}" data-idx="${i}">Elimina</button></td>`;
        tbody.appendChild(tr);

        tr.querySelector('.del-btn').onclick = e => {
          const tipo = e.target.dataset.tipo;
          const idx = parseInt(e.target.dataset.idx);
          let cats = loadCategories();
          cats[tipo].splice(idx, 1);
          saveCategories(cats);
          renderCategorie();
          setCategoryOptions(document.getElementById('tipo').value);
        };
      });
    });
  }

  document.getElementById('newCatForm').onsubmit = e => {
    e.preventDefault();
    const cat = document.getElementById('nuovaCat').value.trim();
    const tipo = document.getElementById('catTipo').value;
    if(!cat){
      alert('Inserisci una categoria');
      return;
    }
    let cats = loadCategories();
    if(cats[tipo].includes(cat)){
      alert('Categoria già esistente');
      return;
    }
    cats[tipo].push(cat);
    saveCategories(cats);
    renderCategorie();
    setCategoryOptions(document.getElementById('tipo').value);
    document.getElementById('nuovaCat').value = '';
    alert('Categoria aggiunta!');
  }
</script>

</body>
</html>
